<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>London's Key Bus Line Real Time Tracker </title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <!--Stylesheets-->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" type="text/css">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">     

    <!--JavaScript-->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
    <script src="script.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    

</head>
<body>
<div id='map' style='width: 800px; height: 600px;'></div>

<div class="line-selection">
    <table>
        <tr><td><a class="lineButton">Line 8</a></td></tr>
        <tr><td><a class="lineButton">Line 9</a></td></tr>
        <tr><td><a class="lineButton">Line 11</a></td></tr>
        <tr><td><a class="lineButton">Line 14</a></td></tr>
        <tr><td><a class="lineButton">Line 15</a></td></tr>
        <tr><td><a class="lineButton">Line 23</a></td></tr>
        <tr><td><a class="lineButton">Line 24</a></td></tr>
        <tr><td><a class="lineButton">Line 25</a></td></tr>
        <tr><td><a class="lineButton">Line 38</a></td></tr>
        <tr><td><a class="lineButton">Line 43</a></td></tr>
        <tr><td><a class="lineButton">Line 59</a></td></tr>
        <tr><td><a class="lineButton">Line 73</a></td></tr>
        <tr><td><a class="lineButton">Line 74</a></td></tr>
        <tr><td><a class="lineButton">Line 88</a></td></tr>
        <tr><td><a class="lineButton">Line 139</a></td></tr>
        <tr><td><a class="lineButton">Line 148</a></td></tr>
        <tr><td><a class="lineButton">Line 159</a></td></tr>
        <tr><td><a class="lineButton">Line 188</a></td></tr>
        <tr><td><a class="lineButton">Line 205</a></td></tr>
        <tr><td><a class="lineButton">Line 274</a></td></tr>
        <tr><td><a class="lineButton">Line 390</a></td></tr>
        <tr><td><a class="lineButton">Line 453</a></td></tr>
    </table>
</div>

<div id="container">
    <!-- populated by JS-->
</div>

<script>
var coordsLine = "";

mapboxgl.accessToken = 'pk.eyJ1IjoiZGFud2VzdGZhbGwiLCJhIjoiY2tsdm9sMTZ2MDE0ZzJwbzNsZjZnanR3diJ9.siHEwArUzuKkseW3Xa72tg';

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/danwestfall/ckm70cxfd1tot17m894ctkfqv',
    center: [-0.115, 51.500],
    zoom: 10.0,
    });

async function switchLine(lineNumber){

    var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/danwestfall/ckm70cxfd1tot17m894ctkfqv',
    center: [-0.115, 51.500],
    zoom: 10.0,
    });

	var myHeaders = new Headers();
	myHeaders.append("Cookie", "__cfduid=ddd8e249dcd6cce5220655528e9813aa21615584664");

	var requestOptions = {
		method: 'GET',
		headers: myHeaders,
		redirect: 'follow'
	}
	
	let url = "https://api.tfl.gov.uk/Line/" + lineNumber + "/Route/Sequence/inbound?app_id=MIT%20xPro%20Homework&app_key=03cd84bdd6b540a8a6559c46c4ddf806"

	let response = await fetch(url , requestOptions);
	var busJson = await response.json();

coordsLine = JSON.parse(busJson.lineStrings);

var geojson = {
	'type': 'Feature',
	'properties': {},
	'geometry': {
	'type': 'LineString',
	'coordinates': coordsLine[0]
	}
	};

map.addSource('route', {
	'type': 'geojson',
	'data': geojson
	});

map.addLayer({
	'id': 'route',
	'type': 'line',
	'source': 'route',
	'layout': {
	'line-join': 'round',
	'line-cap': 'round'
	},
	'paint': {
	'line-color': '#FFF',
	'line-width': 3
	}
    
	});

    map.addLayer({
    'id': 'markers',
    'type': 'symbol',
	'source': 'route',
    'layout': {
    'icon-allow-overlap': true
    }
    });



var coordinates = coordsLine[0];

var bounds = coordinates.reduce(function (bounds, coord) {
    return bounds.extend(coord);
        }, 
    new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

    map.fitBounds(bounds, {
        padding: 20
    });

map.on('click', function(e) {

});

const data = busJson.stations;
const length = data.length;

var busStops = [];

for (let i = 0; i < length; i++) {

    let a = data[i];
    let bsName = a.name;
    let bsCoord = [a.lon, a.lat]
    let lineListing = "| ";
    let itemNum = i;
    
    for (let j = 0; j < a.lines.length; j++) {
            const b = a.lines[j].name;
            lineListing = lineListing +  b.toString() + " | ";
        };

    busStops.push([itemNum, bsName, bsCoord, lineListing])

}

console.log(busStops);
busStops.forEach(element =>

    element.itemNum = new mapboxgl.Marker()
        .setLngLat([element[2][0], element[2][1]])
        .setPopup(new mapboxgl.Popup({ offset: [0, -15] })
        .setHTML('<h3>' + element[1] + '</h3><p> Lines that service this route: <br>' + element[3] + '</p>'))
        .addTo(map)
)


};



var userSelection = document.getElementsByClassName('lineButton');

for(var i = 0; i < userSelection.length; i++) {
    (function(index) {
        userSelection[index].addEventListener("click", function() {
            let newArray = [8,9,11,14,15,23,24,25,38,43,59,73,74,88,139,148,159,188,205,274,390,453];
            let arg = newArray[index];
            switchLine(arg);
            
        })
    })(i);
}



</script>

</body>
</html>









